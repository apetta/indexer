import KalamintMintHandler from './kalamint_mint';
import { transactionsToEvents } from '../event-producer';
import { Transactions } from '../../../types';

test('creates KALAMINT_MINT events', async () => {
  const transactions: Transactions = [
    {
      id: 45851244232704,
      level: 1397326,
      timestamp: '2021-03-23T14:18:46Z',
      block: 'BMW9DgUeSSHVRea2326UxEuBC1VfVqKY2ETbLUfhbcM96djtKGP',
      hash: 'onydd1obUbqPG58BcJy7VSQZL3rWpg6ReBxg2hj5ig54VXXKzFU',
      counter: 7327811,
      sender: {
        alias: 'MAIKEUL',
        address: 'tz1fP1xrV55sqTV3zfdxvYpqbLcE92GAZbnR',
      },
      target: {
        alias: 'Kalamint Art House',
        address: 'KT1EpGgjQs73QfFJs9z7m1Mxm5MTnpC2tqse',
      },
      amount: 0,
      parameter: {
        entrypoint: 'mint',
        value: {
          name: 'Assange',
          price: '0',
          symbol: 'MAIKE',
          on_sale: false,
          category: 'art',
          editions: '1',
          keywords: 'MAIKEUL',
          token_id: '2',
          ipfs_hash: 'ipfs://QmQvpivtb3FrfBSungbGaXb5eMExmzWpxYNYyhyn3AvjVX',
          creator_name: 'maikeul',
          collection_id: '0',
          collection_name: 'MAIKEUL',
          creator_royalty: '15',
          token_metadata_uri: '697066733a2f2f516d595765474a546373756d6e6f643344516e683158626268326b65695544435532524557394b51767848615841',
        },
      },
      status: 'applied',
      hasInternals: true,
      initiator: null,
      storage: {
        x: '1',
        ledger: 857,
        paused: false,
        tokens: 861,
        auctions: {},
        metadata: 858,
        operators: 859,
        all_tokens: '3',
        bidding_fee: '4',
        collections: 856,
        max_royalty: '50',
        trading_fee: '25',
        max_editions: '25',
        administrator: 'tz1SotrT1MEeC8bNeGzgBLUb3ryfASsFsdun',
        ipfs_registry: 'KT1QZt5o2eU2ymEpUW8EFhybaLpd9cWfqfUL',
        token_metadata: 860,
        all_collections: '1',
        auction_factory: 'KT1MiSxkVDFDrAMYCZZXdBEkNrf1NWzfnnRR',
        metadata_string: {},
        id_max_increment: '100',
        trading_fee_collector: 'tz1ijy2Z7sSmmxPqsZ6iGRn1ZHrCtpwR7XNm',
      },
      diffs: [
        {
          bigmap: 861,
          path: 'tokens',
          action: 'add_key',
          content: {
            hash: 'expruDuAZnFKqmLoisJqUGqrNzXTvw7PJM2rYk97JErM5FHCerQqgn',
            key: '2',
            value: {
              owner: 'tz1fP1xrV55sqTV3zfdxvYpqbLcE92GAZbnR',
              price: '0',
              extras: {
                name: 'Assange',
                symbol: 'MAIKE',
                category: 'art',
                keywords: 'MAIKEUL',
                creator_name: 'maikeul',
                collection_name: 'MAIKEUL',
              },
              creator: 'tz1fP1xrV55sqTV3zfdxvYpqbLcE92GAZbnR',
              on_sale: false,
              decimals: '0',
              editions: '1',
              token_id: '2',
              ipfs_hash: 'ipfs://QmQvpivtb3FrfBSungbGaXb5eMExmzWpxYNYyhyn3AvjVX',
              on_auction: false,
              collection_id: '0',
              edition_number: '1',
              creator_royalty: '15',
            },
          },
        },
        {
          bigmap: 860,
          path: 'token_metadata',
          action: 'add_key',
          content: {
            hash: 'expruDuAZnFKqmLoisJqUGqrNzXTvw7PJM2rYk97JErM5FHCerQqgn',
            key: '2',
            value: {
              token_id: '2',
              token_info: {
                '': '697066733a2f2f516d595765474a546373756d6e6f643344516e683158626268326b65695544435532524557394b51767848615841',
                decimals: '30',
              },
            },
          },
        },
        {
          bigmap: 857,
          path: 'ledger',
          action: 'add_key',
          content: {
            hash: 'expru8Zqx3EEbAHfkZrJ2GV931ig2rHAetU3w7VtRSSQivMgL7vQne',
            key: {
              nat: '2',
              address: 'tz1fP1xrV55sqTV3zfdxvYpqbLcE92GAZbnR',
            },
            value: '1',
          },
        },
      ],
      nonce: null,
    },
    {
      id: 45851979284480,
      level: 1397337,
      timestamp: '2021-03-23T14:29:46Z',
      block: 'BLGCc5zERTSfGLZpbPzfm57N1m7QhwZkfWWsuxUp6do7qiNt91b',
      hash: 'opSptXNgWnaWw1iuuPV7F7wTL453sMKwNuJyq8eAHB26sxbycre',
      counter: 7327815,
      sender: {
        alias: 'MAIKEUL',
        address: 'tz1fP1xrV55sqTV3zfdxvYpqbLcE92GAZbnR',
      },
      target: {
        alias: 'Kalamint Art House',
        address: 'KT1EpGgjQs73QfFJs9z7m1Mxm5MTnpC2tqse',
      },
      amount: 0,
      parameter: {
        entrypoint: 'mint',
        value: {
          name: 'Popeye',
          price: '1200000000',
          symbol: 'MAIKE',
          on_sale: true,
          category: 'art',
          editions: '2',
          keywords: 'MAIKEUL',
          token_id: '10',
          ipfs_hash: 'ipfs://QmV3RPPTGgdWNr4rTqHwULUzmRQYDwvqPNTGgwRS5YYtS3',
          creator_name: 'maikeul',
          collection_id: '2',
          collection_name: 'MAIKEUL',
          creator_royalty: '15',
          token_metadata_uri: '697066733a2f2f516d55566863786a6e696943435271736a4656444b5563677853314c4b614537684d396365434a54613341663947',
        },
      },
      status: 'applied',
      hasInternals: true,
      initiator: null,
      storage: {
        x: '2',
        ledger: 857,
        paused: false,
        tokens: 861,
        auctions: {},
        metadata: 858,
        operators: 859,
        all_tokens: '12',
        bidding_fee: '4',
        collections: 856,
        max_royalty: '50',
        trading_fee: '25',
        max_editions: '25',
        administrator: 'tz1SotrT1MEeC8bNeGzgBLUb3ryfASsFsdun',
        ipfs_registry: 'KT1QZt5o2eU2ymEpUW8EFhybaLpd9cWfqfUL',
        token_metadata: 860,
        all_collections: '3',
        auction_factory: 'KT1MiSxkVDFDrAMYCZZXdBEkNrf1NWzfnnRR',
        metadata_string: {},
        id_max_increment: '100',
        trading_fee_collector: 'tz1ijy2Z7sSmmxPqsZ6iGRn1ZHrCtpwR7XNm',
      },
      diffs: [
        {
          bigmap: 861,
          path: 'tokens',
          action: 'add_key',
          content: {
            hash: 'expruXiL5LQuHx7RcPZztJUFDi93bbuMnKL3AryPqLeM6HkWRAVCeL',
            key: '10',
            value: {
              owner: 'tz1fP1xrV55sqTV3zfdxvYpqbLcE92GAZbnR',
              price: '1200000000',
              extras: {
                name: 'Popeye',
                symbol: 'MAIKE',
                category: 'art',
                keywords: 'MAIKEUL',
                creator_name: 'maikeul',
                collection_name: 'MAIKEUL',
              },
              creator: 'tz1fP1xrV55sqTV3zfdxvYpqbLcE92GAZbnR',
              on_sale: true,
              decimals: '0',
              editions: '2',
              token_id: '10',
              ipfs_hash: 'ipfs://QmV3RPPTGgdWNr4rTqHwULUzmRQYDwvqPNTGgwRS5YYtS3',
              on_auction: false,
              collection_id: '2',
              edition_number: '1',
              creator_royalty: '15',
            },
          },
        },
        {
          bigmap: 861,
          path: 'tokens',
          action: 'add_key',
          content: {
            hash: 'exprugoUUkTmJphCejTLPwF9gbKm2WonYuUBXYqtkc16JVBWe3bdqv',
            key: '11',
            value: {
              owner: 'tz1fP1xrV55sqTV3zfdxvYpqbLcE92GAZbnR',
              price: '1200000000',
              extras: {
                name: 'Popeye',
                symbol: 'MAIKE',
                category: 'art',
                keywords: 'MAIKEUL',
                creator_name: 'maikeul',
                collection_name: 'MAIKEUL',
              },
              creator: 'tz1fP1xrV55sqTV3zfdxvYpqbLcE92GAZbnR',
              on_sale: true,
              decimals: '0',
              editions: '2',
              token_id: '11',
              ipfs_hash: 'ipfs://QmV3RPPTGgdWNr4rTqHwULUzmRQYDwvqPNTGgwRS5YYtS3',
              on_auction: false,
              collection_id: '2',
              edition_number: '2',
              creator_royalty: '15',
            },
          },
        },
        {
          bigmap: 860,
          path: 'token_metadata',
          action: 'add_key',
          content: {
            hash: 'expruXiL5LQuHx7RcPZztJUFDi93bbuMnKL3AryPqLeM6HkWRAVCeL',
            key: '10',
            value: {
              token_id: '10',
              token_info: {
                '': '697066733a2f2f516d55566863786a6e696943435271736a4656444b5563677853314c4b614537684d396365434a54613341663947',
                decimals: '30',
              },
            },
          },
        },
        {
          bigmap: 860,
          path: 'token_metadata',
          action: 'add_key',
          content: {
            hash: 'exprugoUUkTmJphCejTLPwF9gbKm2WonYuUBXYqtkc16JVBWe3bdqv',
            key: '11',
            value: {
              token_id: '11',
              token_info: {
                '': '697066733a2f2f516d55566863786a6e696943435271736a4656444b5563677853314c4b614537684d396365434a54613341663947',
                decimals: '30',
              },
            },
          },
        },
        {
          bigmap: 857,
          path: 'ledger',
          action: 'add_key',
          content: {
            hash: 'exprtxtJwsV6GouhLtKQk6MhKqfDjiCzRKatbesm26SdVwXhCT1QbU',
            key: {
              nat: '10',
              address: 'tz1fP1xrV55sqTV3zfdxvYpqbLcE92GAZbnR',
            },
            value: '1',
          },
        },
        {
          bigmap: 857,
          path: 'ledger',
          action: 'add_key',
          content: {
            hash: 'expru8wi3XBx4Tnr9GmyHvpVtEcsh6SMf2Vg7ewTnsdLBpy4eDhnuw',
            key: {
              nat: '11',
              address: 'tz1fP1xrV55sqTV3zfdxvYpqbLcE92GAZbnR',
            },
            value: '1',
          },
        },
        {
          bigmap: 856,
          path: 'collections',
          action: 'add_key',
          content: {
            hash: 'expruDuAZnFKqmLoisJqUGqrNzXTvw7PJM2rYk97JErM5FHCerQqgn',
            key: '2',
            value: ['11', '10'],
          },
        },
      ],
      nonce: null,
    },
  ];

  const events = transactionsToEvents(transactions, [KalamintMintHandler]);

  expect(events).toStrictEqual([
    {
      id: '90de97527a25b22f11f7d14c1e6c4a3c',
      type: 'KALAMINT_MINT',
      opid: '45851244232704',
      ophash: 'onydd1obUbqPG58BcJy7VSQZL3rWpg6ReBxg2hj5ig54VXXKzFU',
      timestamp: '2021-03-23T14:18:46Z',
      level: 1397326,
      fa2_address: 'KT1EpGgjQs73QfFJs9z7m1Mxm5MTnpC2tqse',
      token_id: '2',
      editions: '1',
      artist_address: 'tz1fP1xrV55sqTV3zfdxvYpqbLcE92GAZbnR',
      is_verified_artist: true,
      price: '0',
      kalamint_on_sale: false,
      kalamint_editions: '1',
      kalamint_edition: '1',
      metadata_uri: 'ipfs://QmYWeGJTcsumnod3DQnh1Xbbh2keiUDCU2REW9KQvxHaXA',
      royalty_shares: {
        decimals: 2,
        shares: {
          tz1fP1xrV55sqTV3zfdxvYpqbLcE92GAZbnR: '15',
        },
      },
    },
    {
      id: 'c4e824bfbe8f0a975d753c7c554bcd4b',
      type: 'KALAMINT_MINT',
      opid: '45851979284480',
      ophash: 'opSptXNgWnaWw1iuuPV7F7wTL453sMKwNuJyq8eAHB26sxbycre',
      timestamp: '2021-03-23T14:29:46Z',
      level: 1397337,
      fa2_address: 'KT1EpGgjQs73QfFJs9z7m1Mxm5MTnpC2tqse',
      token_id: '10',
      editions: '1',
      artist_address: 'tz1fP1xrV55sqTV3zfdxvYpqbLcE92GAZbnR',
      is_verified_artist: true,
      price: '1200000000',
      kalamint_on_sale: true,
      kalamint_editions: '2',
      kalamint_edition: '1',
      metadata_uri: 'ipfs://QmUVhcxjniiCCRqsjFVDKUcgxS1LKaE7hM9ceCJTa3Af9G',
      royalty_shares: {
        decimals: 2,
        shares: {
          tz1fP1xrV55sqTV3zfdxvYpqbLcE92GAZbnR: '15',
        },
      },
    },
    {
      id: 'e41f2daeab06709a8a0ed2db9a1c2f4d',
      type: 'KALAMINT_MINT',
      opid: '45851979284480',
      ophash: 'opSptXNgWnaWw1iuuPV7F7wTL453sMKwNuJyq8eAHB26sxbycre',
      timestamp: '2021-03-23T14:29:46Z',
      level: 1397337,
      fa2_address: 'KT1EpGgjQs73QfFJs9z7m1Mxm5MTnpC2tqse',
      token_id: '11',
      editions: '1',
      artist_address: 'tz1fP1xrV55sqTV3zfdxvYpqbLcE92GAZbnR',
      is_verified_artist: true,
      price: '1200000000',
      kalamint_on_sale: true,
      kalamint_editions: '2',
      kalamint_edition: '2',
      metadata_uri: 'ipfs://QmUVhcxjniiCCRqsjFVDKUcgxS1LKaE7hM9ceCJTa3Af9G',
      royalty_shares: {
        decimals: 2,
        shares: {
          tz1fP1xrV55sqTV3zfdxvYpqbLcE92GAZbnR: '15',
        },
      },
    },
  ]);
});
